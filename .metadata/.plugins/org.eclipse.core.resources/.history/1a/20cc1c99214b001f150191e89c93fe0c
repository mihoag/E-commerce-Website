const messageEmail = document.getElementById("messageEmail");
const email = document.getElementById("email");
const formNewUser = document.forms['formNewUser']

function showMessageEmail(message)
{
	messageEmail.classList.remove("hidden");
	messageEmail.innerText = message;
}



$("#fileImage").change(function() {
		if (!checkFileSize(this)) {
			return;
		}

		showImageThumbnail(this);
});
	
function showImageThumbnail(fileInput) {
	var file = fileInput.files[0];
	var reader = new FileReader();
	reader.onload = function(e) {
		$("#thumbnail").attr("src", e.target.result);
	};

	reader.readAsDataURL(file);
}

function checkFileSize(fileInput) {
	fileSize = fileInput.files[0].size;

	if (fileSize > MAX_FILE_SIZE) {
		fileInput.setCustomValidity("You must choose an image less than " + MAX_FILE_SIZE + " bytes!");
		fileInput.reportValidity();

		return false;
	} else {
		fileInput.setCustomValidity("");

		return true;
	}
}
	
async function checkEmailUnique(form) {
			var userEmail = $("#email").val();
	        var userId = $("#id").val();
	 
	         var params = {id : userId ,email : userEmail};
	 
             const url = '/MyshopAdmin/api/users/check_email';          
             $.post(url, params, async function (response) {
				  if (response == "OK") {
			      form.submit();
		     } else if (response == "Duplicated") {
			  showMessageEmail("The email is existed"); 
		     } 
			 }).fail(function () {
				 showMessageEmail("Fail to connect to server");
			 }); 
			return false;
}


formNewUser.addEventListener('submit', async function(event) {
        // Prevent the default form submission
        event.preventDefault();
        await checkEmailUnique(event.target);
});

email.addEventListener('blur',  function(event) {
        var emailText = event.target.value;
        const response = fetchApiCheckEmail(emailText);
        var params = {email : emailText};
             const url = '/MyshopAdmin/api/users/check_email';          
             $.post(url, params, async function (response) {
				  if (response == "OK") {
			       messageEmail.classList.add("hidden")
		    } else if (response == "Duplicated") {
			    showMessageEmail("The email is existed");
		    }
			}).fail(function () {
				 showMessageEmail("Fail to connect to server");	
			 });
});


